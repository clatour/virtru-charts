apiVersion: argoproj.io/v1alpha1
kind: Workflow
metadata:
  generateName: github-action-argo-submit-
spec:
  podGC:
    strategy: OnWorkflowCompletion
  arguments:
#! global to the workflow
    parameters:
    - name: buildImage
      value: "{{workflow.parameters.buildImage}}"
    - name: gitRepoName
      value: "{{workflow.parameters.gitRepoName}}"
    - name: charts
      value: |
        [
          { "directory": "cse" },
          { "directory": "cks" },
        ]
  entrypoint: virtru-charts-pipeline
  serviceAccountName: argo-events-sa
  templates:
    - name: get-chart-info
      inputs:
        parameters:
        - chartDirectory
      script:
        image: python:alpine3.6
        command: [python]
        source: |
          import yaml, semver, json
          with open('/src/{{inputs.parameters.gitRepoName}}/{{inputs.parameters.chartDirectory}}/Chart.yaml') as f:
            chart_yaml = yaml.load(f, Loader=yaml.FullLoader)
            info_json = {'directory':'{{inputs.parameters.chartDirectory}}', 'chartVersion':chart_yaml['version'], 'appVersion':chart_yaml['appVersion']}
            json.dumps(info_json)

    - name: virtru-charts-pipeline
      steps:
      - - name: get-chart-info
          template: get-chart-info
          arguments:
            parameters:
              - name: chartDirectory
                value: "{{item.directory}}"
          withParam: "{{inputs.parameters.charts}}"

      - - name: git-checkout-with-gitops
          templateRef:
            name: cwft-git
            template: git-checkout-with-gitops
            clusterScope: true
          arguments:
            parameters:
            - name: gitRepoName
              value: "{{workflow.parameters.gitRepoName}}"
            - name: gitRepoUrl
              value: "https://github.com/virtru-corp/virtru-charts.git"
            - name: defaultBranch
              value: "main"
            - name: credentialSecretName
              value: "virtru-cloudnative-secrets"

      - - name: strip-chart-version
          templateRef:
            name: cwft-helm
            template: strip-chart-version
            clusterScope: true
          arguments:
            parameters:
            - name: buildImage
              value: "{{workflow.parameters.buildImage}}"
            - name: chartVersion
              value: "{{steps.get-chart-version.outputs.result}}"
              value: "{{item.chartVersion}}"
          withItems: "{{steps.get-chart-info.outputs.result}}"

      - - name: helm-set-chart-versions
          templateRef:
            - name: chartDirectory
              value: "{{item.directory}}"
            - name: chartVersion
              value: "{{steps.strip-chart-version.outputs.result}}"
              value: "{{item.chartVersion}}"
            - name: defaultBranch
              value: main
            - name: dockerTag
              value: "{{steps.get-app-version.outputs.result}}"
              value: "{{item.appVersion}}"
            - name: githubOrg
              value: virtru-corp
            - name: githubSecretName
              value: virtru-cloudnative-secrets
          withItems: "{{steps.get-chart-info.outputs.result}}"

      - - name: helm-push
          templateRef:
            name: cwft-helm
            template: helm-push-it
            clusterScope: true
          arguments:
            artifacts:
            - name: repo-source
              from: "{{steps.helm-set-chart-versions.outputs.artifacts.repo-source}}"
            parameters:
            - name: buildImage
              value: "{{workflow.parameters.buildImage}}"
            - name: chartDirectory
              value: "{{item.directory}}"
            - name: gitRepoName
              value: "{{workflow.parameters.gitRepoName}}"
            - name: chartVersion
              value: "{{item.chartVersion}}"
          withItems: "{{steps.get-chart-info.outputs.result}}"
